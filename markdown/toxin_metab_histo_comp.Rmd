---
title: "toxin_metab_histo_comp"
output: html_document
date: "2023-09-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(broom)
library(cowplot)
library(magrittr)
library(qiime2R)
library(tidyverse)
library(naniar)
library(ggpubr)
library(rstatix)
```

**Functions**
```{r}
file_prep <- function(metadata_fp,
                      metab_fp,
                      metab_col_filter,
                      metab_filter,
                      histo_fp,
                      toxin_fp){
  ## metadata file
  metadata <- read_tsv(metadata_fp)
  ## metabolomics file
  metab <- read_csv(metab_fp)
  wanted_metab_ids <- metab$mouse_id
  metadata %>% 
    group_by(mouse_id) %>% 
    filter(mouse_id %in% wanted_metab_ids) %>% 
    left_join(metab, by = 'mouse_id') %>% 
    select(-(all_of(metab_col_filter))) %>% 
    gather(metab_filter, key = metabolite, value = concentration) %>% 
    filter(!is.na(mouse_id)) -> pre_metab
  ## changes all 'ND' values in the concentration column to 0 
  pre_metab$concentration[pre_metab$concentration == 'ND'] <- 0
  pre_metab %>% 
    filter(!is.na(concentration)) %>% 
    mutate(concentration = as.numeric(concentration)) %>% 
    distinct(mouse_id, concentration, .keep_all = TRUE) -> big_metab
  ## histopathology file
  histo <- read_csv(histo_fp) %>% 
           filter(!is.na(mouse_id))
  metadata %>% 
    merge(histo, by = 'mouse_id') %>% 
    group_by(mouse_id) %>% 
    filter(day_post_inf == max(day_post_inf)) %>% 
    ungroup() %>% 
    mutate(day_post_inf = as.factor(day_post_inf)) %>% 
    gather(cecum, colon, key = tissue, value = score) -> big_histo
  ## toxin file
  toxin <- read_tsv(toxin_fp)
  wanted_toxin_ids <- toxin$mouse_id
  metadata %>% 
    group_by(mouse_id) %>% 
    filter(mouse_id %in% wanted_toxin_ids) -> meta_filt
  toxin %>% 
    left_join(meta_filt, by = 'mouse_id') %>% 
    gather('Total TcA Neat', 'Total TcB Neat', 
           key = neat_toxin, value = neat_conc) %>% 
    gather('Total TcA 1:10', 'Total TcB 1:10',
           key = dil_toxin, value = dil_conc) -> pre_toxin
  
  pre_toxin$neat_conc[pre_toxin$neat_conc == 'BDL'] <- '0'
  pre_toxin$dil_conc[pre_toxin$dil_conc == 'BDL'] <- '0'
  pre_toxin$dil_conc[pre_toxin$dil_conc == 'Chow'] <- '0'
  
  pre_toxin %>% 
    filter(!is.na(dil_conc),
           !is.na(neat_conc)) %>%
    mutate(neat_conc = as.numeric(neat_conc),
           dil_conc = as.numeric(dil_conc)) %>% 
    select(-'Extra_Sample', -'Tube_Label', -'Collection Date',
           -'Sample_Type') -> big_toxin
  big_toxin %>% 
    distinct(mouse_id, dil_conc, .keep_all = TRUE) %>% 
    filter(diet != 'Chow') -> dil_toxin
  big_toxin %>%
    distinct(mouse_id, neat_conc, .keep_all = TRUE) -> neat_toxin 
  ## creating a list of my outputs
  my_list <- list(Metadata = metadata,
                  Metabolomics = big_metab,
                  Histopathology = big_histo,
                  Toxin = big_toxin,
                  NeatToxin = neat_toxin,
                  DilToxin = dil_toxin)
  return(my_list)
}

## histo plot comparison function 
comp_plot <- function(histo_table,
                      ## toxin or metabolomics?
                       wanted_table,
                       ## this is what you want your x axiss to be (neat, diluted, or concentration)? 
                       wanted_x,
                       ## this is toxin/metabolite column you want to filter by (neat or diluted)?
                       wanted_y,
                       ## what is the toxin/metabolite you want to filter by called in the table?
                       wanted_y_name,
                       diet_labels,
                       tissue_labels,
                       title){
  ## putting tables together
  histo_table %>% 
    select(mouse_id, tissue, score) %>% 
    left_join(wanted_table, by = 'mouse_id') -> compiled_table
  ## constructing plot
  compiled_table %>% 
    filter(.data[[wanted_y]] == wanted_y_name) %>% 
    na.omit() %>% 
    ggplot(aes(x = .data[[wanted_x]], y = score)) +
    scale_x_continuous(trans = 'log10') +
    geom_jitter(alpha = 0.4, width = 0.1, height = 0) +
    geom_smooth(method = 'lm', se = FALSE) +
    facet_grid(tissue~diet,
               labeller = labeller(tissue = tissue_labels,
                                   diet = diet_labels),
               scales = 'free_y') +
    theme_bw() +
    theme(strip.text.y = element_text(angle = 0)) +
    xlab('Concentration') +
    ylab('Score') +
    ggtitle(title) -> plot
  return(plot)
}
```


**File Paths**
```{r}
metadata_FP <- '../data/misc/processed_metadata.tsv'
histo_FP <- '../data/misc/histo_data.csv'
metab_FP <- '../data/misc/metabolomics.csv'
toxin_FP <- '../data/misc/toxin_final_data.tsv'

## lists to redo the diet names on the facet labels of the ggplot created below 
diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')

names(diet_labs) <- c('Chow', 'HF/HF', 'HF/LF', 'LF/HF', 'LF/LF')

tissue_labs <- c('Cecum',
                 'Colon')
names(tissue_labs) <- c('cecum',
                        'colon')
wanted_metabs <- c('Acetic Acid (ug/g)',
                   'Propanoic Acid (ug/g)',
                   'n-Butanoic Acid (ug/g)')
unwanted_columns <- c('2-methyl-propanoic acid (ug/g)',
                     'Isopentanoic Acid (ug/g)',
                     '2-methyl-Butanoic Acid (ug/g)',
                     'Pentanoic Acid (ug/g)',
                     'Notes',
                     'Sample Group',
                     'SCFA Data File',
                     'Acq. Date-Time',
                     'Tube_Label',
                     'Sample_Type',
                     'Collection Date',
                     'Dil.')
metab_labs <- c('Acetic Acid',
                'Propanoic Acid',
                'n-Butanoic Acid')
names(metab_labs) <- wanted_metabs
neat_labs <- c('TcdA', 'TcdB')
names(neat_labs) <- c('Total TcA Neat', 'Total TcB Neat')

dil_labs <- c('TcdA', 'TcdB')
names(dil_labs) <- c('Total TcA 1:10', 'Total TcB 1:10')
```

**File Prep**
```{r}
comp_files <- file_prep(metadata_FP,
                        metab_FP,
                        unwanted_columns,
                        wanted_metabs,
                        histo_FP,
                        toxin_FP)

metadata <- comp_files$Metadata
metab <- comp_files$Metabolomics
histo <- comp_files$Histopathology
big_toxin <- comp_files$Toxin
dil_toxin <- comp_files$DilToxin
neat_toxin <- comp_files$NeatToxin
```

**Comparisons To Do:**
- toxin and metab concentration to cecal and colon histo scores (on a plot, faceted by diet, x = toxin, y = histo score)
- toxin and metab concentrations by diet (to each other)

**Toxin to Histopathology Scores Comparisons**

**Neat Toxin Concentration Comparison**
overall neat plot!
```{r, warning=FALSE, fig.height=4, fig.width=8}
histo %>% 
  select(mouse_id, tissue, score) %>% 
  left_join(neat_toxin, by = 'mouse_id') -> histo_neat_toxin

histo_neat_toxin %>% 
  na.omit() %>% 
  ggplot(aes(x = neat_conc, y = score)) +
  scale_x_continuous(trans = 'log10') +
  geom_jitter(aes(fill = diet), alpha = 0.6, width = 0.1, height = 0, pch = 21) +
  scale_fill_brewer(palette = 'Dark2', name = 'Diet',
                    labels = c('Chow',
                               'HFt/HFb',
                               'HFt/LFb',
                               'LFt/HFb',
                               'LFt/LFb')) +
  geom_smooth(method = 'lm', se = FALSE) +
  facet_grid(tissue~neat_toxin,
             labeller = labeller(tissue = tissue_labs,
                                 neat_toxin = neat_labs),
             scales = 'free_y') +
  theme_bw() +
  theme(strip.text.y = element_text(angle = 0)) +
  xlab('Concentration') +
  ylab('Score') +
  ggtitle('Neat C. difficile Toxin Concentration to Histopathology Score') -> neat_histo_plot

neat_histo_plot
```

**Neat TcdA and TcdB Plot Construction**
```{r, warning=FALSE, fig.height=4, fig.width=9}
## neat tcdA
neat_histo_tca_plot <- comp_plot(histo,
                                 neat_toxin,
                                 'neat_conc',
                                 'neat_toxin',
                                 'Total TcA Neat',
                                 diet_labs,
                                 tissue_labs,
                                 'Neat TcdA')
## neat tcdB
neat_histo_tcb_plot <- comp_plot(histo,
                                 neat_toxin,
                                 'neat_conc',
                                 'neat_toxin',
                                 'Total TcB Neat',
                                 diet_labs,
                                 tissue_labs,
                                 'Neat TcdB')
neat_histo_tcb_plot
```


**Diluted Toxin Concentration Comparison**
```{r, warning=FALSE, fig.height=4, fig.width=8}
histo %>% 
  select(mouse_id, tissue, score) %>% 
  left_join(dil_toxin, by = 'mouse_id') -> histo_dil_toxin

histo_dil_toxin %>% 
  na.omit() %>% 
  ggplot(aes(x = dil_conc, y = score)) +
  scale_x_continuous(trans = 'log10') +
  geom_jitter(aes(fill = diet), alpha = 0.6, width = 0.1, height = 0, pch = 21) +
  scale_fill_brewer(palette = 'Dark2', name = 'Diet',
                    labels = c('HFt/HFb',
                               'HFt/LFb',
                               'LFt/HFb',
                               'LFt/LFb')) +
  geom_smooth(method = 'lm', se = FALSE) +
  facet_grid(tissue~dil_toxin,
             labeller = labeller(tissue = tissue_labs,
                                 dil_toxin = dil_labs),
             scales = 'free_y') +
  theme_bw() +
  theme(strip.text.y = element_text(angle = 0)) +
  xlab('Diluted Toxin Concentration') +
  ylab('Histopathology Score') +
  ggtitle('Diluted C. difficile Toxin Concentration to Histopathology Score') -> dil_histo_plot

dil_histo_plot
```


**Diluted TcdA and TcdB Plot Construction**
```{r, warning=FALSE, fig.height=4, fig.width=9}
## diluted tcdA
dil_histo_tca_plot <- comp_plot(histo,
                                dil_toxin,
                                'dil_conc',
                                'dil_toxin',
                                'Total TcA 1:10',
                                 diet_labs,
                                 tissue_labs,
                                 'Diluted TcdA')
## diluted tcdB
dil_histo_tcb_plot <- comp_plot(histo,
                                dil_toxin,
                                'dil_conc',
                                'dil_toxin',
                                'Total TcB 1:10',
                                 diet_labs,
                                 tissue_labs,
                                 'Diluted TcdB')
dil_histo_tcb_plot
```

**Toxin Plots Together!**
```{r, warning=FALSE, fig.height=7, fig.width=15}
plot_grid(neat_histo_tca_plot, neat_histo_tcb_plot,
          dil_histo_tca_plot, dil_histo_tcb_plot,
          nrow = 2,
          labels = c('a)', 'b)', 'c)', 'd)')) -> toxin_histo_plots

toxin_histo_plots
```

**Metaboloite Concentration Comparisons to Histopathology Score**
overall plot!
```{r, warning=FALSE, fig.height=4, fig.width=8}
histo %>% 
  select(mouse_id, tissue, score) %>% 
  left_join(metab, by = 'mouse_id') -> histo_metab

histo_metab %>% 
  na.omit() %>% 
  ggplot(aes(x = concentration, y = score)) +
  scale_x_continuous(trans = 'log10') +
  geom_jitter(aes(fill = diet), alpha = 0.6, width = 0.1, height = 0, pch = 21) +
  scale_fill_brewer(palette = 'Dark2', name = 'Diet',
                    labels = c('Chow',
                               'HFt/HFb',
                               'HFt/LFb',
                               'LFt/HFb',
                               'LFt/LFb')) +
  geom_smooth(method = 'lm', se = FALSE) +
  facet_grid(tissue~metabolite,
             labeller = labeller(tissue = tissue_labs,
                                 metabolite = metab_labs),
             scales = 'free_y') +
  theme_bw() +
  theme(strip.text.y = element_text(angle = 0)) +
  xlab('Concentration (ug/g)') +
  ylab('Score') +
  ggtitle('Metabolite Concentration by Histopathology Score') -> histo_metab_overall

histo_metab_overall
```


**Metabolomics Plots (faceted by diet)**
```{r, warning=FALSE, fig.height=5, fig.width=10}
## acetic acid
histo_acetic_plot <- comp_plot(histo,
                               metab,
                               'concentration',
                               'metabolite',
                               'Acetic Acid (ug/g)',
                               diet_labs,
                               tissue_labs,
                               'Acetic Acid')

## n-butanoic acid
histo_butanoic_plot <- comp_plot(histo,
                                 metab,
                                 'concentration',
                                 'metabolite',
                                 'n-Butanoic Acid (ug/g)',
                                 diet_labs,
                                 tissue_labs,
                                 'n-Butanoic Acid')
## propanoic acid
histo_propanoic_plot <- comp_plot(histo,
                                 metab,
                                 'concentration',
                                 'metabolite',
                                 'Propanoic Acid (ug/g)',
                                 diet_labs,
                                 tissue_labs,
                                 'Propanoic Acid')

histo_acetic_plot
```

**Metabolite Plots Together!!**
```{r, warning=FALSE, fig.height=8, fig.width=19}
plot_grid(histo_acetic_plot, histo_butanoic_plot,
          histo_propanoic_plot, histo_metab_overall,
          nrow = 2,
          labels = c('a)', 'b)', 'c)', 'd)')) -> metab_histo_plot

metab_histo_plot
```

**Saving my Outputs**
```{r}
ggsave('histo_toxin_comp.pdf',
       plot = toxin_histo_plots,
       width = 15,
       height = 7,
       path = '../plots')
ggsave('histo_metab_comp.pdf',
       plot = metab_histo_plot,
       width = 19.5,
       height = 8.5,
       path = '../plots')
```

